name: Bookkeeping Pipeline (Neural Core L6)

on:
  workflow_dispatch:
    inputs:
      period:
        description: "Tax period (e.g., 2023-2024)"
        required: true
        default: "2023-2024"
  push:
    paths:
      - "ai/**"
      - "business/bookkeeping/**"
      - "config/bookkeeping.yaml"
      - ".github/workflows/bookkeeping_pipeline.yml"

jobs:
  validate-and-dryrun:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate L6 assets exist
        run: |
          test -f ai/ai_state_graph.json
          test -f ai/ai_ruleset.yaml
          test -f ai/module_registry.yaml
          test -f ai/l6_orchestrator.py
          test -f business/bookkeeping/bookkeeping_os.md
          test -f config/bookkeeping.yaml
          echo "L6 assets OK"

      - name: Print state graph
        run: |
          python - << 'PY'
          import json,sys
          d=json.load(open("ai/ai_state_graph.json"))
          print("States:", d.get("states"))
          print("Transitions:", d.get("transitions"))
          PY

      - name: Dry-run L6 orchestrator (bookkeeping)
        run: |
          python ai/l6_orchestrator.py bookkeeping || true
        env:
          PERIOD: ${{ inputs.period }}

      - name: Summary
        run: |
          echo "Neural-core dry-run completed for module 'bookkeeping' (period=${{ inputs.period }})."
